<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Éditeur de Bâtiments en Temps Réel - EcoSim</title>

    <link rel="stylesheet" href="menu-style.css">
    <link rel="stylesheet" href="step1-style.css">
    
    <style>
        /* editeur.css */
        * ===================================================================
        * === STYLES SPÉCIFIQUES POUR L'ÉDITEUR (INCHANGÉS) ===
        * ===================================================================
        * Utilise les variables globales de `step1-style.css` pour une apparence cohérente.
        */

        /* Utilisation des polices globales */
        html, body {
            font-family: var(--font-body);
        }

        /* Adaptation du conteneur principal de l'éditeur */
        .editor-wrapper {
            margin-left: 160px; /* Doit correspondre à la largeur du .floating-menu */
            width: calc(100% - 160px);
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 1em;
            box-sizing: border-box;
            overflow-y: auto; /* Permet le défilement du contenu de l'éditeur */
            background-color: var(--color-parchment); /* Fond cohérent */
        }

        .editor-wrapper header { text-align: center; margin-bottom: 1em; flex-shrink: 0; }
        .editor-wrapper h1, .editor-wrapper h2, .editor-wrapper h3 { color: var(--color-royal-blue); font-family: var(--font-title); }

        .container {
            display: flex;
            flex-grow: 1;
            gap: 1em;
            overflow: hidden;
            min-height: 0;
        }

        #navigation-pane, #editor-pane, #analysis-pane {
            background-color: #f9f6ef; /* Un beige très clair pour les panneaux */
            padding: 1em;
            border-radius: 8px;
            overflow-y: auto;
            border: 1px solid var(--color-border);
        }

        #navigation-pane { flex: 0 0 320px; }
        #editor-pane { flex: 2 1 50%; }
        #analysis-pane { flex: 1 1 25%; }

        #navigation-pane ul { list-style-type: none; padding-left: 15px; }
        #navigation-pane .location-type > span, #navigation-pane .category > span { font-weight: bold; cursor: pointer; display: block; padding: 4px 0; font-family: var(--font-title); }
        #navigation-pane .location-type > span { font-size: 1.2em; }
        #navigation-pane .category > span { font-size: 1.1em; }
        #navigation-pane .building { color: var(--color-dark-text); cursor: pointer; padding: 4px 0; border-left: 3px solid transparent; padding-left: 10px; margin-left: 10px;}
        #navigation-pane .building:hover { color: var(--color-royal-blue); border-left-color: var(--color-royal-blue);}
        #navigation-pane .selected { color: var(--color-royal-blue); font-weight: bold; border-left-color: var(--color-gold); background-color: rgba(212, 160, 23, 0.1); }
        .collapsible-content { display: none; padding-left: 15px;}
        .expanded > .collapsible-content { display: block; }

        form { display: flex; flex-direction: column; gap: 1em; }
        fieldset {
            border: 1px solid var(--color-border);
            border-radius: 6px;
            padding: 1em;
            margin-bottom: 1em;
            background-color: #fff;
        }
        legend { font-weight: bold; color: var(--color-royal-blue); padding: 0 0.5em; font-family: var(--font-title); }
        label { display: flex; align-items: center; margin-bottom: 0.5em; font-weight: 500; }
        input[type="text"], input[type="number"], textarea, select {
            width: 100%;
            padding: 8px;
            background-color: #fff;
            color: var(--color-dark-text);
            border: 1px solid var(--color-border);
            border-radius: 4px;
            box-sizing: border-box;
            font-family: var(--font-body);
        }
        textarea { height: 80px; resize: vertical; }

        .job-container { margin-top: 1em; border-left: 3px solid var(--color-gold); padding-left: 1em; position: relative; padding-top: 1.5em; }
        .grid-2, .grid-3 { display: grid; gap: 1em; }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }

        .button-group { display: flex; gap: 1em; margin-top: 1em; }

        #placeholder { text-align: center; margin-top: 3em; color: #888; }

        .header-with-button { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1em; }
        .header-with-button h2 { margin: 0; }
        #add-tag-btn {
            padding: 0; width: 28px; height: 28px; font-size: 1.2em;
            line-height: 28px; border-radius: 50%; flex-shrink: 0;
        }

        #analysis-output h3 { margin-top: 20px; border-bottom: 1px solid var(--color-gold); padding-bottom: 5px; }
        #analysis-output .tag-list { list-style-type: none; padding-left: 0; }
        #analysis-output .tag-list li { padding: 5px; border-radius: 4px; margin-bottom: 5px; }
        #analysis-output .tag-orphan { color: var(--color-error); font-weight: bold; background-color: rgba(183, 28, 28, 0.1); border-left: 3px solid var(--color-error); }
        #analysis-output .tag-unused { color: #c08b00; font-weight: bold; background-color: rgba(226, 160, 74, 0.1); border-left: 3px solid #e2a04a; }
        #analysis-output .building-list { font-size: 0.9em; color: #555; padding-left: 15px; margin-top: 5px; }
        .delete-job-btn { position: absolute; top: 5px; right: 5px; }

        /* Styles de la modale */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); display: none; justify-content: center;
            align-items: center; z-index: 1000;
        }
        .modal-content {
            background-color: var(--color-parchment); padding: 2em; border-radius: 8px;
            width: 90%; max-width: 600px; border: 2px solid var(--color-gold);
            max-height: 90vh; display: flex; flex-direction: column;
        }
        .modal-content h2 { margin-top: 0; }
        .modal-content .form-group { margin-bottom: 1em; }
        .modal-content .button-group { justify-content: flex-end; }
        .hidden { display: none; }

        .tag-widget, .keyvalue-widget {
            border: 1px solid var(--color-border); border-radius: 5px; padding: 1em;
            background-color: #fdfaf2;
        }
        .tag-list-container, .kv-list-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
        .tag-item, .kv-item {
            display: flex; align-items: center; gap: 8px;
            background-color: #e8e0c9; padding: 5px 10px;
            border-radius: 15px; font-size: 0.9em;
        }
        .kv-item { border-radius: 5px; width: 100%; }
        .kv-item input { width: auto; flex-grow: 1; }
        .delete-btn {
            cursor: pointer; background-color: var(--color-error); color: white;
            border: none; border-radius: 50%; width: 20px; height: 20px;
            display: inline-flex; justify-content: center; align-items: center;
            font-weight: bold; line-height: 1;
        }
        .add-item-form { display: flex; gap: 10px; margin-top: 10px; }
        .add-item-form input, .add-item-form select { flex-grow: 1; }

        #export-modal textarea {
            width: 100%; height: 250px; background-color: #fff; color: var(--color-dark-text);
            border: 1px solid var(--color-border); border-radius: 4px;
            padding: 0.5em; box-sizing: border-box; margin-bottom: 1em; margin-top: 1em;
        }

        /* Styles pour la simulation et l'analyse */
        .simulation-table {
            width: 100%; border-collapse: collapse; margin-top: 1em; font-size: 0.9em;
        }
        .simulation-table th, .simulation-table td { border: 1px solid var(--color-border); padding: 8px; text-align: center; }
        .simulation-table th { background-color: #e8e0c9; color: var(--color-royal-blue); }
        .simulation-table td { background-color: #fff; }
        .simulation-table .stat-col { min-width: 110px; }

        .analysis-tabs { display: flex; border-bottom: 2px solid var(--color-gold); margin-bottom: 1em; }
        .analysis-tab-btn {
            padding: 10px 15px; cursor: pointer; background-color: transparent; border: none;
            color: var(--color-dark-text); border-bottom: 3px solid transparent; font-size: 1em;
            margin: 0; transition: color 0.2s, border-color 0.2s; font-family: var(--font-title);
        }
        .analysis-tab-btn:hover { color: var(--color-royal-blue); background-color: #e8e0c9; }
        .analysis-tab-btn.active { color: var(--color-royal-blue); border-bottom-color: var(--color-royal-blue); font-weight: bold; }
        .analysis-tab-content { display: none; }
        .analysis-tab-content.active { display: block; }

        .tooltip {
            display: inline-block; margin-left: 8px; color: var(--color-royal-blue); cursor: help;
            border: 1px solid var(--color-border); border-radius: 50%; width: 18px; height: 18px;
            text-align: center; line-height: 18px; font-size: 0.85em; font-weight: bold; user-select: none;
        }
        legend .tooltip { margin-bottom: 0; }

        /*
        * ===================================================================
        * === STYLES POUR LA LISTE D'ANALYSE DÉPLIANTE (NOUVEAU) ===
        * ===================================================================
        */

        #analysis-output .clickable-tag {
            cursor: pointer;
            font-weight: bold;
            display: block;
            padding: 6px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        #analysis-output .clickable-tag:hover {
            background-color: #e8e0c9;
        }

        /* Le contenu du dépliant est caché par défaut */
        #analysis-output .tag-info {
            display: none;
            padding: 10px 10px 10px 15px; /* haut droit bas gauche */
            margin-left: 10px;
            margin-top: 5px;
            border-left: 2px solid var(--color-gold);
            background-color: rgba(255, 255, 255, 0.5);
        }

        #analysis-output .info-list {
            list-style-type: none;
            padding-left: 10px;
            font-size: 0.9em;
            color: #333;
        }

        #analysis-output .tag-info h4 {
            margin: 10px 0 5px 0;
            font-size: 0.95em;
            color: var(--color-royal-blue);
        }

        #analysis-output .tag-info h4.required {
            color: var(--color-error);
        }

        /* Conserver le style pour les liens de bâtiments à l'intérieur du dépliant */
        #analysis-output .building-link {
            cursor: pointer;
            color: var(--color-dark-text);
            text-decoration: underline;
            text-decoration-color: var(--color-border);
        }

        #analysis-output .building-link:hover {
            color: var(--color-royal-blue);
            text-decoration-color: var(--color-royal-blue);
        }
    </style>
</head>
<body>

<nav class="floating-menu">
    <div class="menu-title">EcoSimRPG</div>
    <a href="index.html" id="nav-index">Accueil</a>
    <a href="step1.html" id="nav-step1">Étape 1<br><small>(Carte)</small></a>
    <a href="step2.html" id="nav-step2" class="nav-disabled">Étape 2<br><small>(Conf. Lieux)</small></a>
    <a href="step3.html" id="nav-step3" class="nav-disabled">Étape 3<br><small>(Gen.0)</small></a>
    <a href="step4.html" id="nav-step4" class="nav-disabled">Étape 4<br><small>(Simulation)</small></a>
    <a href="step5.html" id="nav-step5" class="nav-disabled">Étape 5<br><small>(Données)</small></a>
    <a href="editeur.html" id="nav-editor" style="border-top: 1px solid #ccc; color: #4a90e2;" class="active">Éditeur<br><small>(Bâtiments)</small></a>
    <a href="races_editor.html" id="nav-races-editor" style="color: #4a90e2;">Éditeur<br><small>(Races)</small></a>
</nav>

    <div class="editor-wrapper">

        <header>
            <h1>Éditeur de Bâtiments en Temps Réel</h1>
            <p>Charge les données depuis `buildings.js`. Les modifications sont sauvegardées automatiquement.</p>
            <div class="button-group" style="padding: 0 1em 1em 1em; justify-content: flex-end; margin-top: 0;">
                <button id="import-data-btn" class="btn btn-secondary">Importer un JSON</button>
                <input type="file" id="json-upload" accept=".json" style="display:none;">
                <button id="open-manage-modal-btn" class="btn btn-edit">Exporter / Gérer</button>
           </div>
           </header>
    
        <div class="container" id="editor-view">
            <div id="navigation-pane">
                <h2>Arborescence</h2>
                <div id="tree-container"></div>
                <div class="button-group">
                    <button id="add-building-btn" class="btn btn-primary">Ajouter un Bâtiment</button>
                    <button id="purge-buildings-btn" class="btn btn-delete">Purger</button>
                </div>
            </div>
            <div id="editor-pane">
                <div id="placeholder">
                    <h2>Bienvenue dans l'éditeur EcoSim</h2>
                    <p>Sélectionnez un bâtiment pour commencer ou ajoutez-en un nouveau.</p>
                </div>
                <form id="building-form" style="display:none;"></form>
            </div>
            <div id="analysis-pane">
                <div class="header-with-button">
                    <h2>Analyse en Temps Réel</h2>
                    <button id="add-tag-btn" class="btn btn-secondary" title="Ajouter un nouveau tag fourni globalement">+</button>
                </div>
                <div id="analysis-output"></div>
            </div>
        </div>
    
        <div id="add-building-modal" class="modal-overlay">
            <div class="modal-content">
                <h2>Ajouter un nouveau bâtiment</h2>
                <form id="add-building-form-modal">
                    <div class="form-group">
                        <label for="modal-location-type">Type de Lieu</label>
                        <select id="modal-location-type"></select>
                        <input type="text" id="modal-new-location-type" class="hidden" placeholder="Nouveau type de lieu..." style="margin-top: 5px;"/>
                    </div>
                    <div class="form-group">
                        <label for="modal-category">Catégorie</label>
                        <select id="modal-category"></select>
                        <input type="text" id="modal-new-category" class="hidden" placeholder="Nouvelle catégorie..." style="margin-top: 5px;"/>
                    </div>
                    <div class="form-group">
                        <label for="modal-building-name">Nom du Bâtiment</label>
                        <input type="text" id="modal-building-name" required />
                    </div>
                    <div class="button-group">
                        <button type="button" id="modal-cancel-btn" class="btn btn-secondary">Annuler</button>
                        <button type="submit" id="modal-create-btn" class="btn btn-primary">Créer</button>
                    </div>
                </form>
            </div>
        </div>
    
        <div id="manage-data-modal" class="modal-overlay">
            <div class="modal-content">
                <h2>Gérer les Données</h2>
                <p>Téléchargez vos modifications au format JSON pour les sauvegarder ou réinitialisez l'éditeur à son état d'origine.</p>
                <div class="button-group">
                    <button id="reset-all-btn" class="btn btn-delete">Restaurer les Données d'Origine</button>
                    <button id="download-json-btn" class="btn btn-primary">Télécharger le JSON</button>
                    <button type="button" id="manage-modal-close-btn" class="btn btn-secondary">Fermer</button>
                </div>
            </div>
        </div>
    
    <script src="buildings.js"></script>

    <script defer>
        // editeur.js
        document.addEventListener('DOMContentLoaded', () => {
            // === CONSTANTES ===
            const CUSTOM_BUILDINGS_STORAGE_KEY = 'ecoSimRPG_buildings_custom';

            // --- DOM Elements ---
            const treeContainer = document.getElementById('tree-container');
            const buildingForm = document.getElementById('building-form');
            const placeholder = document.getElementById('placeholder');
            const addBuildingBtn = document.getElementById('add-building-btn');
            const resetAllBtn = document.getElementById('reset-all-btn');
            const analysisOutput = document.getElementById('analysis-output');
            const addBuildingModal = document.getElementById('add-building-modal');
            const modalForm = document.getElementById('add-building-form-modal');
            const modalLocationSelect = document.getElementById('modal-location-type');
            const modalNewLocationInput = document.getElementById('modal-new-location-type');
            const modalCategorySelect = document.getElementById('modal-category');
            const modalNewCategoryInput = document.getElementById('modal-new-category');
            const modalBuildingNameInput = document.getElementById('modal-building-name');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            const purgeBuildingsBtn = document.getElementById('purge-buildings-btn');
            const addTagBtn = document.getElementById('add-tag-btn');

            // --- NOUVEAUX SELECTEURS ---
            const importDataBtn = document.getElementById('import-data-btn');
            const jsonUploadInput = document.getElementById('json-upload');
            const openManageModalBtn = document.getElementById('open-manage-modal-btn');
            const manageDataModal = document.getElementById('manage-data-modal');
            const manageModalCloseBtn = document.getElementById('manage-modal-close-btn');
            const downloadJsonBtn = document.getElementById('download-json-btn');

            let ecoSimData = null;
            let selectedBuildingPath = null;
            let originalData = null; 
            let userDefinedTags = [];
            let allTagsCache = new Set(); 
            let orphanTags = [];
            let unusedTags = [];

            // --- Fonctions d'Import/Export & Sauvegarde ---
            function saveCustomBuildingsToStorage() {
                if (ecoSimData && ecoSimData.buildings) {
                    localStorage.setItem(CUSTOM_BUILDINGS_STORAGE_KEY, JSON.stringify(ecoSimData.buildings));
                } else {
                    console.error('Erreur : Aucune donnée de bâtiment à sauvegarder.');
                }
            }

            function downloadJSON() {
                try {
                    const jsonData = JSON.stringify(ecoSimData.buildings, null, 4);
                    const blob = new Blob([jsonData], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    const date = new Date().toISOString().slice(0, 10);
                    a.href = url;
                    a.download = `ecosim_buildings_data-${date}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    alert('Le fichier JSON a été téléchargé.');
                } catch (error) {
                    console.error("Erreur lors de la création du JSON :", error);
                    alert("Une erreur s'est produite lors de la génération du fichier JSON.");
                }
            }

            function handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const newBuildingData = JSON.parse(e.target.result);
                        if (typeof newBuildingData === 'object' && newBuildingData !== null && Object.keys(newBuildingData).length > 0) {
                            if (confirm("Charger ce fichier remplacera les données actuelles dans l'éditeur. Continuer ?")) {
                                ecoSimData.buildings = newBuildingData;
                                selectedBuildingPath = null;
                                renderNavigation();
                                displayBuildingForm();
                                updateRealTimeAnalysis();
                                saveCustomBuildingsToStorage();
                                alert('Données chargées avec succès !');
                            }
                        } else {
                            alert('Fichier JSON invalide ou vide.');
                        }
                    } catch (error) {
                        console.error('Erreur de parsing JSON :', error);
                        alert('Erreur lors de la lecture du fichier. Assurez-vous que le format JSON est correct.');
                    } finally {
                        jsonUploadInput.value = '';
                    }
                };
                reader.readAsText(file);
            }

            // --- Logique de l'Editeur (inchangée) ---
            function deepClone(obj) { return JSON.parse(JSON.stringify(obj)); }
            function getObjectFromPath(obj, path) { if (!path) return undefined; return path.reduce((acc, key) => (acc && acc[key] !== 'undefined') ? acc[key] : undefined, obj); }
            function renderNavigation() { treeContainer.innerHTML = ''; Object.keys(ecoSimData.buildings).sort().forEach(locationType => { const locDiv = document.createElement('div'); locDiv.className = 'location-type collapsible'; locDiv.innerHTML = `<span>${locationType}</span><div class="collapsible-content"></div>`; treeContainer.appendChild(locDiv); const contentDiv = locDiv.querySelector('.collapsible-content'); const locData = ecoSimData.buildings[locationType]; Object.keys(locData).sort().forEach(category => { const catDiv = document.createElement('div'); catDiv.className = 'category collapsible'; catDiv.innerHTML = `<span>${category}</span><div class="collapsible-content"></div>`; contentDiv.appendChild(catDiv); const catContentDiv = catDiv.querySelector('.collapsible-content'); const catData = locData[category]; Object.keys(catData).sort().forEach(buildingName => { const buildingDiv = document.createElement('div'); buildingDiv.className = 'building'; buildingDiv.textContent = buildingName; buildingDiv.dataset.path = JSON.stringify([locationType, category, buildingName]); catContentDiv.appendChild(buildingDiv); }); }); }); updateSelection(); addNavEventListeners(); }
            function addNavEventListeners() { treeContainer.querySelectorAll('.collapsible > span').forEach(span => { span.addEventListener('click', () => { span.parentElement.classList.toggle('expanded'); }); }); treeContainer.querySelectorAll('.building').forEach(buildingDiv => { buildingDiv.addEventListener('click', () => { selectedBuildingPath = JSON.parse(buildingDiv.dataset.path); displayBuildingForm(); updateSelection(); }); }); }
            function updateSelection() { treeContainer.querySelectorAll('.building.selected').forEach(el => el.classList.remove('selected')); if (selectedBuildingPath) { const pathStr = JSON.stringify(selectedBuildingPath); const selectedEl = treeContainer.querySelector(`.building[data-path='${pathStr}']`); if (selectedEl) { selectedEl.classList.add('selected'); let current = selectedEl.parentElement; while (current && current.classList.contains('collapsible-content')) { current.parentElement.classList.add('expanded'); current = current.parentElement.parentElement; } } } }
            function displayBuildingForm() { if (!selectedBuildingPath) { buildingForm.style.display = 'none'; placeholder.style.display = 'block'; return; } const buildingData = getObjectFromPath(ecoSimData.buildings, selectedBuildingPath); if (!buildingData) return; const [locationType, category, buildingName] = selectedBuildingPath; const providesTagsWidget = createTagsWidget('providesTags', buildingData.providesTags || []); const requiresTagsWidget = createRequiresTagsWidget('requiresTags', buildingData.requiresTags || {}); buildingForm.innerHTML = `<h3>Édition de : ${buildingName}</h3><fieldset><legend>Informations Générales</legend><div><label for="buildingName">Nom du Bâtiment <span class="tooltip" title="Le nom affiché du bâtiment dans l'interface et la simulation.">(?)</span></label><input type="text" id="buildingName" value="${buildingName}" /></div><div><label for="description">Description <span class="tooltip" title="Une courte description narrative du bâtiment, pour l'ambiance et le contexte.">(?)</span></label><textarea id="description">${buildingData.description || ''}</textarea></div></fieldset><fieldset><legend>Tags Fournis <span class="tooltip" title="Les 'ressources' ou concepts (ex: 'Sécurité', 'Nourriture') que ce bâtiment produit ou met à disposition des autres bâtiments.">(?)</span></legend>${providesTagsWidget}</fieldset><fieldset><legend>Tags Requis <span class="tooltip" title="Les 'ressources' ou concepts que ce bâtiment nécessite pour fonctionner. La distance est la portée maximale à laquelle il peut chercher cette ressource.">(?)</span></legend>${requiresTagsWidget}</fieldset><div id="jobs-section"></div><div class="button-group"><button type="button" id="add-job-btn" class="btn btn-secondary">Ajouter un Emploi</button><button type="button" id="delete-building-btn" class="btn btn-delete">Supprimer ce Bâtiment</button></div>`; const jobsSection = document.getElementById('jobs-section'); (buildingData.emplois || []).forEach((job, index) => { jobsSection.appendChild(createJobForm(job, index)); }); placeholder.style.display = 'none'; buildingForm.style.display = 'flex'; addFormEventListeners(); addWidgetsEventListeners(); }
            function createJobForm(jobData, index) { const jobDiv = document.createElement('fieldset'); jobDiv.className = 'job-container'; jobDiv.dataset.jobIndex = index; const statsWidget = createKeyValueWidget(`job-gains-stats-${index}`, jobData.gainsMensuels?.stats || {}, 'Nom Stat', 'Valeur'); jobDiv.innerHTML = `<legend>Emploi ${index + 1}: ${jobData.titre || 'Nouveau'}</legend><button type="button" class="btn-danger delete-job-btn" data-job-index="${index}">X</button><div class="grid-3"><div><label>Titre: <span class="tooltip" title="Le nom du poste. Apparaîtra dans l'interface de simulation.">(?)</span></label><input type="text" class="job-titre" value="${jobData.titre || ''}" /></div><div><label>Tier: <span class="tooltip" title="Niveau hiérarchique (0=dirigeant, 5=bas). Impacte retraite et prestige.">(?)</span></label><input type="number" class="job-tier" value="${jobData.tier || 0}" /></div><div><label>Postes: <span class="tooltip" title="Nombre total de personnes pouvant occuper cet emploi.">(?)</span></label><input type="number" class="job-postes" value="${jobData.postes || 0}" /></div></div><div class="grid-2"><div><label>Salaire (cuivre): <span class="tooltip" title="Le salaire mensuel de base en pièces de cuivre.">(?)</span></label><input type="number" class="job-salaire" value="${jobData.salaire?.totalEnCuivre || 0}" /></div><div><label>Prérequis Prestige: <span class="tooltip" title="Le prestige minimum requis pour postuler à cet emploi.">(?)</span></label><input type="number" class="job-prerequis-prestige" value="${jobData.prerequis?.prestige || 0}" /></div></div><div><label>Type d'emploi: <span class="tooltip" title="Définit si le poste est ouvert aux hommes, aux femmes, ou aux deux.">(?)</span></label><select class="job-type"><option value="mixte" ${jobData.type === 'mixte' ? 'selected' : ''}>Mixte</option><option value="homme" ${jobData.type === 'homme' ? 'selected' : ''}>Homme</option><option value="femme" ${jobData.type === 'femme' ? 'selected' : ''}>Femme</option></select></div><fieldset><legend>Gains Mensuels</legend><div><label>Prestige: <span class="tooltip" title="Le montant de prestige gagné chaque mois en occupant ce poste.">(?)</span></label><input type="number" step="0.1" class="job-gains-prestige" value="${jobData.gainsMensuels?.prestige || 0}" /></div><div><label>Stats: <span class="tooltip" title="Gains de stats brutes par mois. Ces valeurs sont faibles (ex: 0.1) et s'accumulent.">(?)</span></label>${statsWidget}</div></fieldset>`; return jobDiv; }
            function createTagsWidget(id, tags) { const tagItems = tags.map(tag => `<div class="tag-item" data-tag="${tag}"><span>${tag}</span><button type="button" class="delete-btn" data-tag="${tag}">x</button></div>`).join(''); return `<div id="${id}" class="tag-widget"><div class="tag-list-container">${tagItems}</div><div class="add-item-form"><input type="text" placeholder="Ajouter un tag..." /><button type="button" class="btn btn-secondary add-btn">Ajouter</button></div></div>`; }
            function createRequiresTagsWidget(id, tags) { const tagOptions = [...allTagsCache].sort().map(t => `<option value="${t}">${t}</option>`).join(''); const tagItems = Object.entries(tags).map(([tag, details]) => `<div class="kv-item" data-tag="${tag}"><input type="text" value="${tag}" disabled style="flex-grow:2;"><input type="number" class="kv-value" value="${details.distance || 0}" placeholder="Distance"><button type="button" class="delete-btn" data-tag="${tag}">x</button></div>`).join(''); return `<div id="${id}" class="keyvalue-widget"><div class="kv-list-container">${tagItems}</div><div class="add-item-form"><select><option value="">Choisir un tag...</option>${tagOptions}</select><input type="number" value="1" placeholder="Distance"><button type="button" class="btn btn-secondary add-btn">Ajouter</button></div></div>`; }
            function createKeyValueWidget(id, data, keyPlaceholder, valuePlaceholder) { const items = Object.entries(data).map(([key, value]) => `<div class="kv-item" data-key="${key}"><input type="text" class="kv-key" value="${key}"><input type="number" step="0.1" class="kv-value" value="${value}"><button type="button" class="delete-btn" data-key="${key}">x</button></div>`).join(''); return `<div id="${id}" class="keyvalue-widget"><div class="kv-list-container">${items}</div><div class="add-item-form"><input type="text" class="new-kv-key" placeholder="${keyPlaceholder}"><input type="number" step="0.1" class="new-kv-value" placeholder="${valuePlaceholder}"><button type="button" class="btn btn-secondary add-btn">Ajouter</button></div></div>`; }
            function addWidgetsEventListeners() { buildingForm.querySelectorAll('.delete-btn').forEach(btn => { btn.addEventListener('click', (e) => { e.target.closest('.tag-item, .kv-item').remove(); updateBuildingData(); }); }); const providesTagsWidget = document.getElementById('providesTags'); providesTagsWidget.querySelector('.add-btn').addEventListener('click', (e) => { const input = e.target.previousElementSibling; const tag = input.value.trim(); if (tag && !providesTagsWidget.querySelector(`.tag-item[data-tag="${tag}"]`)) { const container = providesTagsWidget.querySelector('.tag-list-container'); const newItem = document.createElement('div'); newItem.className = 'tag-item'; newItem.dataset.tag = tag; newItem.innerHTML = `<span>${tag}</span><button type="button" class="delete-btn" data-tag="${tag}">x</button>`; newItem.querySelector('.delete-btn').addEventListener('click', (e) => { e.target.parentElement.remove(); updateBuildingData(); }); container.appendChild(newItem); input.value = ''; updateBuildingData(); } }); const requiresTagsWidget = document.getElementById('requiresTags'); requiresTagsWidget.querySelector('.add-btn').addEventListener('click', (e) => { const form = e.target.parentElement; const select = form.children[0]; const input = form.children[1]; const tag = select.value; const distance = input.value; if (tag && !requiresTagsWidget.querySelector(`.kv-item[data-tag="${tag}"]`)) { const container = requiresTagsWidget.querySelector('.kv-list-container'); const newItem = document.createElement('div'); newItem.className = 'kv-item'; newItem.dataset.tag = tag; newItem.innerHTML = `<input type="text" value="${tag}" disabled style="flex-grow:2;"><input type="number" class="kv-value" value="${distance}" placeholder="Distance"><button type="button" class="delete-btn" data-tag="${tag}">x</button>`; newItem.querySelector('.delete-btn').addEventListener('click', (e) => { e.target.closest('.kv-item').remove(); updateBuildingData(); }); container.appendChild(newItem); select.value = ''; updateBuildingData(); } }); document.querySelectorAll('[id^="job-gains-stats-"]').forEach(statsWidget => { statsWidget.querySelector('.add-btn').addEventListener('click', e => { const form = e.target.parentElement; const keyInput = form.querySelector('.new-kv-key'); const valueInput = form.querySelector('.new-kv-value'); const key = keyInput.value.trim(); if(key) { const container = statsWidget.querySelector('.kv-list-container'); const newItem = document.createElement('div'); newItem.className = 'kv-item'; newItem.dataset.key = key; newItem.innerHTML = `<input type="text" class="kv-key" value="${key}"><input type="number" step="0.1" class="kv-value" value="${valueInput.value || 0}"><button type="button" class="delete-btn" data-key="${key}">x</button>`; newItem.querySelector('.delete-btn').addEventListener('click', (e) => { e.target.closest('.kv-item').remove(); updateBuildingData(); }); container.appendChild(newItem); keyInput.value = ''; valueInput.value = ''; updateBuildingData(); } }); }); }
            function addFormEventListeners() { buildingForm.addEventListener('change', updateBuildingData); buildingForm.addEventListener('input', (e) => { if(!e.target.closest('.tag-widget, .keyvalue-widget')) { updateBuildingData(e); } }); document.getElementById('add-job-btn').addEventListener('click', addJob); document.getElementById('delete-building-btn').addEventListener('click', deleteBuilding); document.querySelectorAll('.delete-job-btn').forEach(btn => btn.addEventListener('click', deleteJob)); }
            function updateBuildingData() { if (!selectedBuildingPath) return; const buildingData = getObjectFromPath(ecoSimData.buildings, selectedBuildingPath); if (!buildingData) return; const newName = document.getElementById('buildingName').value.trim(); buildingData.description = document.getElementById('description').value; const providesTagsList = []; document.querySelectorAll('#providesTags .tag-item').forEach(item => { providesTagsList.push(item.dataset.tag); }); buildingData.providesTags = providesTagsList; const requiresTagsObj = {}; document.querySelectorAll('#requiresTags .kv-item').forEach(item => { const tag = item.dataset.tag; const distance = parseInt(item.querySelector('.kv-value').value, 10); requiresTagsObj[tag] = { distance: isNaN(distance) ? 0 : distance }; }); buildingData.requiresTags = requiresTagsObj; document.querySelectorAll('.job-container').forEach((jobDiv) => { const index = parseInt(jobDiv.dataset.jobIndex, 10); const job = buildingData.emplois[index]; if(job) { job.titre = jobDiv.querySelector('.job-titre').value; job.tier = parseInt(jobDiv.querySelector('.job-tier').value, 10); job.postes = parseInt(jobDiv.querySelector('.job-postes').value, 10); job.salaire = { totalEnCuivre: parseInt(jobDiv.querySelector('.job-salaire').value, 10) }; job.prerequis = { prestige: parseInt(jobDiv.querySelector('.job-prerequis-prestige').value, 10) }; job.type = jobDiv.querySelector('.job-type').value; if (!job.gainsMensuels) job.gainsMensuels = {}; job.gainsMensuels.prestige = parseFloat(jobDiv.querySelector('.job-gains-prestige').value); const statsObj = {}; jobDiv.querySelectorAll('.kv-item').forEach(item => { const key = item.querySelector('.kv-key').value.trim(); const value = parseFloat(item.querySelector('.kv-value').value); if (key && !isNaN(value)) { statsObj[key] = value; } }); job.gainsMensuels.stats = statsObj; } }); if (newName && newName !== selectedBuildingPath[2]) { const [locationType, category] = selectedBuildingPath; const oldName = selectedBuildingPath[2]; const locCat = ecoSimData.buildings[locationType][category]; Object.defineProperty(locCat, newName, Object.getOwnPropertyDescriptor(locCat, oldName)); delete locCat[oldName]; selectedBuildingPath[2] = newName; renderNavigation(); } updateRealTimeAnalysis(); saveCustomBuildingsToStorage(); }
            function addJob() { const buildingData = getObjectFromPath(ecoSimData.buildings, selectedBuildingPath); if (!buildingData.emplois) buildingData.emplois = []; const newJob = { titre: "Nouvel Emploi", tier: 5, postes: 1, salaire: { totalEnCuivre: 20 }, prerequis: { prestige: 0 }, gainsMensuels: { prestige: 1, stats: {} }, type: "mixte" }; buildingData.emplois.push(newJob); saveCustomBuildingsToStorage(); displayBuildingForm(); }
            function deleteJob(event) { const index = parseInt(event.target.dataset.jobIndex, 10); const buildingData = getObjectFromPath(ecoSimData.buildings, selectedBuildingPath); buildingData.emplois.splice(index, 1); displayBuildingForm(); updateRealTimeAnalysis(); saveCustomBuildingsToStorage(); }
            function deleteBuilding() { if (confirm(`Êtes-vous sûr de vouloir supprimer "${selectedBuildingPath[2]}" ?`)) { const [locationType, category, buildingName] = selectedBuildingPath; delete ecoSimData.buildings[locationType][category][buildingName]; selectedBuildingPath = null; renderNavigation(); displayBuildingForm(); updateRealTimeAnalysis(); saveCustomBuildingsToStorage(); } }
            function purgeAllBuildings() { if (confirm("Êtes-vous sûr de vouloir supprimer tous les bâtiments ?\nLes lieux et catégories seront conservés, mais leur contenu sera vidé. Cette action est irréversible.")) { Object.keys(ecoSimData.buildings).forEach(locationType => { const locData = ecoSimData.buildings[locationType]; Object.keys(locData).forEach(category => { locData[category] = {}; }); }); selectedBuildingPath = null; renderNavigation(); displayBuildingForm(); updateRealTimeAnalysis(); saveCustomBuildingsToStorage(); alert('Tous les bâtiments ont été purgés.'); } }
            function openAddBuildingModal() { modalLocationSelect.innerHTML = '<option value="">Choisir un lieu...</option>'; Object.keys(ecoSimData.buildings).sort().forEach(loc => { modalLocationSelect.innerHTML += `<option value="${loc}">${loc}</option>`; }); modalLocationSelect.innerHTML += '<option value="__new__">--- Créer un nouveau lieu ---</option>'; modalCategorySelect.innerHTML = '<option value="">Choisir d\'abord un lieu...</option>'; modalNewLocationInput.classList.add('hidden'); modalNewCategoryInput.classList.add('hidden'); modalBuildingNameInput.value = ''; addBuildingModal.style.display = 'flex'; }
            function closeAddBuildingModal() { addBuildingModal.style.display = 'none'; }
            function updateModalCategories() { const selectedLoc = modalLocationSelect.value; modalNewLocationInput.classList.toggle('hidden', selectedLoc !== '__new__'); if (selectedLoc && selectedLoc !== '__new__' && ecoSimData.buildings[selectedLoc]) { modalCategorySelect.innerHTML = '<option value="">Choisir une catégorie...</option>'; Object.keys(ecoSimData.buildings[selectedLoc]).sort().forEach(cat => { modalCategorySelect.innerHTML += `<option value="${cat}">${cat}</option>`; }); modalCategorySelect.innerHTML += '<option value="__new__">--- Créer une nouvelle catégorie ---</option>'; } else { modalCategorySelect.innerHTML = '<option value="">Choisir d\'abord un lieu...</option>'; if(selectedLoc !== '__new__') modalCategorySelect.innerHTML += '<option value="__new__">--- Créer une nouvelle catégorie ---</option>'; } updateModalNewCategoryVisibility(); }
            function updateModalNewCategoryVisibility() { const selectedCat = modalCategorySelect.value; modalNewCategoryInput.classList.toggle('hidden', selectedCat !== '__new__'); }
            function handleCreateBuilding(event) { event.preventDefault(); const buildingName = modalBuildingNameInput.value.trim(); if (!buildingName) { alert("Le nom du bâtiment est requis."); return; } let locationType = modalLocationSelect.value; if (locationType === '__new__') { locationType = modalNewLocationInput.value.trim(); } let category = modalCategorySelect.value; if (category === '__new__') { category = modalNewCategoryInput.value.trim(); } if (!locationType || !category) { alert("Le type de lieu et la catégorie sont requis."); return; } if (!ecoSimData.buildings[locationType]) ecoSimData.buildings[locationType] = {}; if (!ecoSimData.buildings[locationType][category]) ecoSimData.buildings[locationType][category] = {}; if (ecoSimData.buildings[locationType][category][buildingName]) { alert("Ce bâtiment existe déjà à cet emplacement."); return; } ecoSimData.buildings[locationType][category][buildingName] = { description: "Nouvelle description.", providesTags: [], requiresTags: {}, emplois: [] }; selectedBuildingPath = [locationType, category, buildingName]; renderNavigation(); displayBuildingForm(); updateRealTimeAnalysis(); saveCustomBuildingsToStorage(); closeAddBuildingModal(); }
            
            function generateTagListHTML(tagList, tagDetails, type) {
                if (tagList.length === 0) {
                    if (type === 'orphan') return "<p>Aucun tag requis n'est orphelin. Tout est lié !</p>";
                    if (type === 'unused') return "<p>Tous les tags fournis sont requis par au moins un bâtiment.</p>";
                    return "<p>Aucun tag trouvé.</p>";
                }

                let listHtml = '<ul class="tag-list">';
                tagList.sort().forEach(tag => {
                    const providedBy = tagDetails[tag]?.providedBy || [];
                    const requiredBy = tagDetails[tag]?.requiredBy || [];
                    let tagClass = '';
                    if (orphanTags.includes(tag)) tagClass = 'tag-orphan';
                    else if (unusedTags.includes(tag)) tagClass = 'tag-unused';

                    listHtml += `<li class="${tagClass}">`;
                    listHtml += `<div class="clickable-tag" data-tag="${tag}">${tag}</div>`;
                    listHtml += `<div class="tag-info">`;

                    const buildLink = (b) => {
                        if (b.path === null) {
                            return `<li>${b.name}</li>`;
                        }
                        const pathJson = JSON.stringify(b.path);
                        const escapedPathJson = pathJson.replace(/'/g, '&#39;');
                        return `<li><span class="building-link" data-path='${escapedPathJson}'>${b.name}</span></li>`;
                    };

                    if (providedBy.length > 0) {
                        listHtml += `<h4>Produit par :</h4><ul class="info-list">`;
                        providedBy.forEach(b => {
                            listHtml += buildLink(b);
                        });
                        listHtml += `</ul>`;
                    }

                    if (requiredBy.length > 0) {
                        listHtml += `<h4 class="required">Requis par :</h4><ul class="info-list">`;
                        requiredBy.forEach(b => {
                            listHtml += buildLink(b);
                        });
                        listHtml += `</ul>`;
                    }

                    listHtml += `</div></li>`;
                });
                listHtml += '</ul>';
                return listHtml;
            }

            function updateRealTimeAnalysis() { const tagDetails = {}; Object.entries(ecoSimData.buildings).forEach(([locationType, locData]) => { Object.entries(locData).forEach(([category, catData]) => { Object.entries(catData).forEach(([buildingName, bldData]) => { const fullBuildingName = `${buildingName} <small>(${locationType} / ${category})</small>`; const buildingPath = [locationType, category, buildingName]; (bldData.providesTags || []).forEach(tag => { if (!tagDetails[tag]) tagDetails[tag] = { providedBy: [], requiredBy: [] }; tagDetails[tag].providedBy.push({ name: fullBuildingName, path: buildingPath }); }); if (bldData.requiresTags) { Object.keys(bldData.requiresTags).forEach(tag => { if (!tagDetails[tag]) tagDetails[tag] = { providedBy: [], requiredBy: [] }; tagDetails[tag].requiredBy.push({ name: fullBuildingName, path: buildingPath }); }); } }); }); }); userDefinedTags.forEach(tag => { if (!tagDetails[tag]) { tagDetails[tag] = { providedBy: [{ name: '(Tag global non assigné)', path: null }], requiredBy: [] }; } }); const allProvided = new Set(Object.keys(tagDetails).filter(tag => tagDetails[tag].providedBy.length > 0)); const allRequired = new Set(Object.keys(tagDetails).filter(tag => tagDetails[tag].requiredBy.length > 0)); allTagsCache = new Set(Object.keys(tagDetails)); const allTagsSorted = [...allTagsCache].sort(); const requiresTagsWidget = document.getElementById('requiresTags'); if (requiresTagsWidget) { const select = requiresTagsWidget.querySelector('select'); if (select) { const currentlySelectedTag = select.value; const tagOptions = allTagsSorted.map(t => `<option value="${t}">${t}</option>`).join(''); select.innerHTML = `<option value="">Choisir un tag...</option>${tagOptions}`; select.value = currentlySelectedTag; } } orphanTags = [...allRequired].filter(tag => !allProvided.has(tag)); unusedTags = [...allProvided].filter(tag => !(tagDetails[tag]?.requiredBy.length > 0)); const activeTab = analysisOutput.querySelector('.analysis-tab-btn.active')?.dataset.tab || 'orphan'; let html = ` <div class="analysis-tabs"> <button class="analysis-tab-btn ${activeTab === 'orphan' ? 'active' : ''}" data-tab="orphan">Orphelins (${orphanTags.length})</button> <button class="analysis-tab-btn ${activeTab === 'unused' ? 'active' : ''}" data-tab="unused">Jamais Requis (${unusedTags.length})</button> <button class="analysis-tab-btn ${activeTab === 'all' ? 'active' : ''}" data-tab="all">Tous les Tags (${allTagsSorted.length})</button> </div> <div id="tab-orphan" class="analysis-tab-content ${activeTab === 'orphan' ? 'active' : ''}"> ${generateTagListHTML(orphanTags, tagDetails, 'orphan')} </div> <div id="tab-unused" class="analysis-tab-content ${activeTab === 'unused' ? 'active' : ''}"> ${generateTagListHTML(unusedTags, tagDetails, 'unused')} </div> <div id="tab-all" class="analysis-tab-content ${activeTab === 'all' ? 'active' : ''}"> ${generateTagListHTML(allTagsSorted, tagDetails, 'all')} </div> `; analysisOutput.innerHTML = html; }
            
            // --- FONCTION DE RESTAURATION MISE À JOUR ---
            function resetAllBuildings() {
                if (confirm("Êtes-vous sûr de vouloir restaurer la configuration d'origine ?\nToutes vos modifications personnalisées seront perdues et remplacées par le fichier natif.")) {
                    // 1. Restaure les données de travail à partir de la copie originale
                    ecoSimData.buildings = deepClone(originalData.buildings);
                    
                    // 2. Réinitialise les tags et la sélection
                    userDefinedTags = [];
                    selectedBuildingPath = null;
                    
                    // 3. Écrase la sauvegarde personnalisée avec les données d'origine
                    saveCustomBuildingsToStorage(); 
                    
                    // 4. Met à jour l'interface utilisateur
                    renderNavigation();
                    displayBuildingForm();
                    updateRealTimeAnalysis();
                    
                    alert("L'éditeur a été réinitialisé avec les données d'origine.");
                }
            }
            
            // --- Initialisation ---
            function init() {
                if (window.EcoSimData && window.EcoSimData.buildings) {
                    // Sauvegarde une copie des données originales au cas où l'utilisateur voudrait restaurer
                    originalData = deepClone(window.EcoSimData);
                    ecoSimData = window.EcoSimData; // Commence avec les données par défaut

                    // --- DÉBUT DE LA LOGIQUE DE CHARGEMENT ---
                    // Vérifie s'il existe une sauvegarde personnalisée dans le localStorage
                    const savedData = localStorage.getItem(CUSTOM_BUILDINGS_STORAGE_KEY);
                    if (savedData) {
                        try {
                            console.log("Configuration personnalisée trouvée, chargement...");
                            const customBuildings = JSON.parse(savedData);
                            // Remplace les données par défaut par les données sauvegardées
                            ecoSimData.buildings = customBuildings; 
                        } catch (error) {
                            console.error("Erreur lors du chargement de la configuration personnalisée :", error);
                            // En cas d'erreur, on continue avec les données par défaut
                        }
                    }
                    // --- FIN DE LA LOGIQUE DE CHARGEMENT ---
                    
                    // Écouteurs pour les fonctionnalités d'import/export
                    importDataBtn.addEventListener('click', () => jsonUploadInput.click());
                    jsonUploadInput.addEventListener('change', handleFileUpload);
                    downloadJsonBtn.addEventListener('click', downloadJSON);

                    addBuildingBtn.addEventListener('click', openAddBuildingModal);
                    resetAllBtn.addEventListener('click', resetAllBuildings);
                    purgeBuildingsBtn.addEventListener('click', purgeAllBuildings);
                    modalForm.addEventListener('submit', handleCreateBuilding);
                    modalCancelBtn.addEventListener('click', closeAddBuildingModal);
                    modalLocationSelect.addEventListener('change', updateModalCategories);
                    modalCategorySelect.addEventListener('change', updateModalNewCategoryVisibility);

                    openManageModalBtn.addEventListener('click', () => { manageDataModal.style.display = 'flex'; });
                    manageModalCloseBtn.addEventListener('click', () => { manageDataModal.style.display = 'none'; });
                    manageDataModal.addEventListener('click', (e) => { if (e.target === manageDataModal) manageDataModal.style.display = 'none'; });

                    addTagBtn.addEventListener('click', () => {
                        const newTag = prompt("Entrez le nom du nouveau tag à ajouter :");
                        if (newTag && newTag.trim() !== '') {
                            const trimmedTag = newTag.trim();
                            const existingTags = new Set([...allTagsCache, ...userDefinedTags].map(t => t.toLowerCase()));
                            if (existingTags.has(trimmedTag.toLowerCase())) {
                                alert(`Le tag "${trimmedTag}" existe déjà.`);
                                return;
                            }
                            userDefinedTags.push(trimmedTag);
                            updateRealTimeAnalysis();
                            alert(`Tag "${trimmedTag}" ajouté. Il apparaîtra comme "Jamais Requis" jusqu'à ce qu'un bâtiment en ait besoin.`);
                        }
                    });

                    analysisOutput.addEventListener('click', (e) => {
                        const tabButton = e.target.closest('.analysis-tab-btn');
                        const clickableTag = e.target.closest('.clickable-tag');
                        const buildingLink = e.target.closest('.building-link');

                        if (tabButton) {
                            const tabId = tabButton.dataset.tab;
                            analysisOutput.querySelectorAll('.analysis-tab-btn').forEach(btn => btn.classList.remove('active'));
                            tabButton.classList.add('active');
                            analysisOutput.querySelectorAll('.analysis-tab-content').forEach(content => content.classList.remove('active'));
                            document.getElementById(`tab-${tabId}`).classList.add('active');
                        }
                        
                        if (clickableTag) {
                            const infoDiv = clickableTag.nextElementSibling;
                            if (infoDiv && infoDiv.classList.contains('tag-info')) {
                                infoDiv.style.display = infoDiv.style.display === 'block' ? 'none' : 'block';
                            }
                        }
                        
                        if (buildingLink) {
                            selectedBuildingPath = JSON.parse(buildingLink.dataset.path);
                            displayBuildingForm();
                            updateSelection();
                        }
                    });

                    renderNavigation();
                    updateRealTimeAnalysis();
                } else {
                    placeholder.innerHTML = "<h2>Erreur de Chargement</h2><p>Le fichier <strong>buildings.js</strong> est introuvable ou mal formaté.</p>";
                    console.error("EcoSimData ou EcoSimData.buildings non trouvé.");
                }
            }
            
            init();
        });
    </script>

</body>
</html>